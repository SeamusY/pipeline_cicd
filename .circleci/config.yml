version: 2.1
orbs: 
  serverless-framework: circleci/serverless-framework@2.0.0
  pulumi: pulumi/pulumi@2.1.0
  aws-cli: circleci/aws-cli@3.1.1
jobs:
  configure-role-arn:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: default
      - aws-cli/role-arn-setup:
          profile-name: new-profile
          role-arn: 'arn:aws:iam::918559970238:user/circleCi_pulumi_deployer'
          source-profile: default
      - run: >-
          aws sts assume-role --role-arn
          "arn:aws:iam::918559970238:user/circleCi_pulumi_deployer" --role-session-name
          AWSCLI-Session
  build:
    docker: 
      - image: cimg/node:16.15.0
    working_directory: ~/Data-Ingestion-Project/aws_infrastructure
    steps:
      - checkout:
          path: ~/Data-Ingestion-Project
      - pulumi/login:
          access-token: $pulumi_access_token
      - run: 
        command: | 
          export AWS_ACCESS_KEY_ID=$accessId
          export AWS_SECRET_ACCESS_KEY=$secret
          npm install
          npm install pulumi
      - pulumi/update:
          working_directory: ~/Data-Ingestion-Project/aws_infrastructure
          stack: $env
      - pulumi/stack_output:
          stack: $env
          property_name: "dev_config"
          env_var: $env
  deploy:
    executor: serverless-framework/default
    steps:
      - checkout
      - aws-cli/setup
      - serverless-framework/setup
      - run:
          command: serverless deploy -v
          name: deploy
workflows:
  deploy:
    jobs:
      - build
      - deploy